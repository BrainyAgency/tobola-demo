<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Jeu de S√©lection ‚Äì Tombola Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
  color:#fff;
  text-align:center;
}
header{padding:25px;}
button{
  padding:10px 15px;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
button:disabled{opacity:.5}
#payBtn{background:#ffd700;font-weight:bold}

#numbers{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(60px,1fr));
  gap:10px;
  max-width:850px;
  margin:20px auto;
}
.numBtn{background:#1abc9c;font-weight:bold}
.numBtn.taken{background:#555;color:#999;cursor:not-allowed}

.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  justify-content:center;
  align-items:center;
  z-index:1000;
}
.modal-content{
  background:#fff;
  color:#000;
  padding:20px;
  border-radius:10px;
  width:90%;
  max-width:350px;
}
input{
  padding:10px;
  margin:8px;
  width:90%;
  border-radius:5px;
  border:none;
}

#offlineBlock{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.9);
  color:#fff;
  align-items:center;
  justify-content:center;
  text-align:center;
  z-index:9999;
}
section{display:none}

table{
  width:95%;
  margin:auto;
  border-collapse:collapse;
}
th,td{border:1px solid #fff;padding:8px}
.ticket{background:#16a085;padding:6px;margin:5px;border-radius:5px}
</style>
</head>

<body>

<div id="offlineBlock">‚ö†Ô∏è Connexion Internet requise</div>

<!-- USER -->
<div id="userInterface">
<header>
  <h1>S.E.A.F PROMOTION</h1>
  <p>Choisissez votre nombre, tentez votre chance et devenez le grand gagnant </p>
  <button id="payBtn">üí≥ Payer le ticket</button>
</header>
<div id="numbers"></div>
</div>

<!-- POPUP JOUEUR -->
<div class="modal" id="popup">
  <div class="modal-content">
    <h3>Entrer vos informations</h3>
    <input id="nameInput" placeholder="Nom complet">
    <input id="phoneInput" placeholder="Num√©ro">
    <input id="ticketInput" placeholder="Code ticket">
    <button onclick="submitPlay()">Valider</button>
    <button onclick="closePopup()">Annuler</button>
  </div>
</div>

<!-- POPUP ADMIN -->
<div class="modal" id="adminPopup">
  <div class="modal-content">
    <h3>PAGE PRIVE</h3>
    <input id="adminNum" placeholder="Num√©ro admin">
    <input id="adminCode" placeholder="Code admin">
    <button onclick="validateAdmin()">Connexion</button>
    <button onclick="closeAdmin()">Annuler</button>
  </div>
</div>

<!-- POPUP INFO -->
<div class="modal" id="infoPopup">
  <div class="modal-content">
    <p id="infoText"></p>
    <button onclick="closeInfo()">OK</button>
  </div>
</div>

<!-- POPUP CONFIRM -->
<div class="modal" id="confirmPopup">
  <div class="modal-content">
    <p id="confirmText"></p>
    <button onclick="confirmYes()">Oui</button>
    <button onclick="confirmNo()">Non</button>
  </div>
</div>

<!-- ADMIN -->
<section id="admin">
<h2>Espace Admin</h2>

<button onclick="generateTicket()">‚ûï G√©n√©rer ticket</button>
<button onclick="toggleTickets()">üé´ Afficher tickets</button>
<div id="tickets" style="display:none"></div>

<h3>Num√©ro gagnant</h3>
<input id="winNumber" type="number" min="0" max="50">
<button onclick="selectWinner()">Valider</button>

<div id="winner"></div>

<button onclick="askReset()">‚ôªÔ∏è R√©initialiser</button>

<h3>üìä Joueurs</h3>
<table>
<thead><tr><th>Nom</th><th>Num√©ro</th><th>Choix</th><th>Ticket</th></tr></thead>
<tbody id="players"></tbody>
</table>
</section>

<script>
/* üîä SONS */
const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
function playSound(freq=400,dur=0.12){
  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.frequency.value=freq;
  o.connect(g); g.connect(audioCtx.destination);
  o.start();
  g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+dur);
  o.stop(audioCtx.currentTime+dur);
}

/* INFO POPUP */
function showInfo(msg){
  playSound(600);
  infoText.innerText=msg;
  infoPopup.style.display="flex";
}
function closeInfo(){infoPopup.style.display="none"}

/* CONFIRM RESET */
let confirmAction=null;
function askReset(){
  playSound(300);
  confirmText.innerText="Confirmer la r√©initialisation du jeu ?";
  confirmAction=resetGame;
  confirmPopup.style.display="flex";
}
function confirmYes(){
  playSound(700);
  confirmPopup.style.display="none";
  confirmAction&&confirmAction();
}
function confirmNo(){
  playSound(200);
  confirmPopup.style.display="none";
}

/* INTERNET */
function checkInternet(){
  offlineBlock.style.display=navigator.onLine?"none":"flex";
}
window.addEventListener("online",checkInternet);
window.addEventListener("offline",checkInternet);
checkInternet();

/* FIREBASE */
firebase.initializeApp({
  apiKey:"AIzaSyAmhpsSUM7kVuRRwLvn2b8U94dNW9YW0jo",
  authDomain:"ppojet-4f3df.firebaseapp.com",
  projectId:"ppojet-4f3df"
});
const db=firebase.firestore();

let selectedNumber=null,hold;

/* NUMBERS */
const numbersDiv=document.getElementById("numbers");
const buttons={};
for(let i=0;i<=50;i++){
  const b=document.createElement("button");
  b.textContent=i;
  b.className="numBtn";
  b.onclick=()=>{playSound();openPopup(i)};
  numbersDiv.appendChild(b);
  buttons[i]=b;
}

db.collection("plays").onSnapshot(s=>{
  Object.values(buttons).forEach(b=>{b.disabled=false;b.classList.remove("taken")});
  s.forEach(d=>{
    buttons[d.data().number].disabled=true;
    buttons[d.data().number].classList.add("taken");
  });
});

function openPopup(n){
  if(buttons[n].disabled) return;
  selectedNumber=n;
  popup.style.display="flex";
}
function closePopup(){popup.style.display="none"}

/* SUBMIT */
function submitPlay(){
  playSound();
  const name=nameInput.value.trim();
  const phone=phoneInput.value.trim();
  const ticket=ticketInput.value.trim();
  if(!name||!phone||!ticket) return showInfo("Tous les champs sont obligatoires");

  db.collection("tickets").doc(ticket).get().then(d=>{
    if(!d.exists||d.data().used) return showInfo("Ticket invalide");
    db.collection("plays").add({name,phone,number:selectedNumber,ticket});
    db.collection("tickets").doc(ticket).update({used:true});
    showInfo("Participation valid√©e");
    popup.style.display="none";
  });
}

/* ADMIN */
payBtn.onmousedown=()=>hold=setTimeout(()=>adminPopup.style.display="flex",3000);
payBtn.onmouseup=()=>clearTimeout(hold);

function validateAdmin(){
  playSound(500);
  if(adminNum.value==="98371280"&&adminCode.value==="963689"){
    adminPopup.style.display="none";
    userInterface.style.display="none";
    admin.style.display="block";
  }else showInfo("Acc√®s refus√©");
}
function closeAdmin(){adminPopup.style.display="none"}

/* ADMIN ACTIONS */
function generateTicket(){
  playSound(600);
  const chars="ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  let t="";
  for(let i=0;i<4;i++)t+=chars[Math.floor(Math.random()*chars.length)];
  db.collection("tickets").doc(t).set({used:false});
  showInfo("Ticket g√©n√©r√© : "+t);
}

function toggleTickets(){
  playSound();
  tickets.style.display=tickets.style.display==="none"?"block":"none";
}

db.collection("tickets").onSnapshot(s=>{
  tickets.innerHTML="";
  s.forEach(d=>{
    if(!d.data().used){
      tickets.innerHTML+=`<div class="ticket">${d.id}
      <button onclick="playSound();navigator.clipboard.writeText('${d.id}')">Partager</button></div>`;
    }
  });
});

function selectWinner(){
  playSound(700);
  const n=Number(winNumber.value);
  db.collection("plays").where("number","==",n).get().then(s=>{
    if(!s.empty){
      const d=s.docs[0].data();
      winner.innerHTML=`üèÜ ${d.name} (${d.phone})`;
    }
  });
}

function resetGame(){
  db.collection("plays").get().then(s=>s.forEach(d=>d.ref.delete()));
  showInfo("Jeu r√©initialis√©");
}

db.collection("plays").onSnapshot(s=>{
  players.innerHTML="";
  s.forEach(d=>{
    const p=d.data();
    players.innerHTML+=`<tr><td>${p.name}</td><td>${p.phone}</td><td>${p.number}</td><td>${p.ticket}</td></tr>`;
  });
});
</script>

</body>
</html>
